<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sound Therapy System v56.22</title>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Segoe UI', sans-serif; text-align: center; }
        #monitor { padding: 30px; border-bottom: 2px solid #0f0; background: #111; }
        .alert { background-color: #800 !important; }
        #status { font-size: 1.2rem; margin: 15px; color: #ff0; text-transform: uppercase; }
        #vol-tag { font-size: 3.5rem; color: #fff; font-weight: bold; margin: 10px; }
        #meter { width: 300px; height: 10px; border: 1px solid #0f0; margin: 10px auto; background: #222; border-radius: 5px; }
        #bar { width: 0%; height: 100%; background: #0f0; }
        input { padding: 12px; width: 55%; background: #000; color: #0f0; border: 1px solid #0f0; margin-bottom: 10px; outline: none; }
        button { padding: 15px 30px; background: #0f0; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; color: #000; }
        #start-btn { display: none; background: #ff0; color: #000; margin-top: 10px; box-shadow: 0 0 15px #ff0; }
    </style>
</head>
<body>

<div id="monitor">
    <h2 style="letter-spacing: 5px;">SOUND THERAPY Hi-Fi v56.22</h2>
    <input type="text" id="url" placeholder="Paste YouTube link here...">
    <br>
    <button onclick="forceLoad()">1. LOAD VIDEO</button>
    <div id="status">Ready for Input</div>
    <div id="vol-tag">VOL: --%</div>
    <div id="meter"><div id="bar"></div></div>
    <button id="start-btn" onclick="activateSystem()">2. ACTIVATE SYSTEM</button>
</div>

<div id="video-area"><div id="player"></div></div>

<script>
    // --- Config (5s Up / 2s Down) ---
    const THRESHOLD = 0.005;
    const UP_TIME = 5000;
    const DOWN_TIME = 2000;
    let currentVol = 20;
    let isUp = false;
    let noiseStart = 0;
    let silenceStart = 0;
    let player = null;
    let fadeTimer = null;

    // Load API immediately
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function extractId(url) {
        const match = url.match(/(?:https?:\/\/)?(?:www\.)?youtu(?:be\.com\/watch\?v=|\.be\/)([\w\-\_]+)/);
        return (match && match[1]) ? match[1] : null;
    }

    // Force Reinjection on Load
    function forceLoad() {
        const videoId = extractId(document.getElementById('url').value);
        if (!videoId) { alert("Invalid YouTube URL"); return; }
        
        document.getElementById('status').innerText = "Forcing Connection...";
        
        if (player) { try { player.destroy(); } catch(e) {} }
        document.getElementById('video-area').innerHTML = '<div id="player"></div>';
        
        player = new YT.Player('player', {
            height: '360', width: '640', videoId: videoId,
            playerVars: { 'autoplay': 0, 'controls': 1, 'vq': 'hd1080' },
            events: {
                'onReady': () => {
                    document.getElementById('start-btn').style.display = 'inline-block';
                    document.getElementById('status').innerText = "Connection Established.";
                    player.setVolume(20);
                }
            }
        });
    }

    function smoothFade(target) {
        if (fadeTimer) clearInterval(fadeTimer);
        fadeTimer = setInterval(() => {
            if (currentVol < target) currentVol++;
            else if (currentVol > target) currentVol--;
            else clearInterval(fadeTimer);
            if (player && player.setVolume) {
                player.setVolume(currentVol);
                document.getElementById('vol-tag').innerText = "VOL: " + currentVol + "%";
            }
        }, 30);
    }

    async function activateSystem() {
        player.playVideo();
        player.setVolume(20);
        document.getElementById('start-btn').style.display = 'none';
