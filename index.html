<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SoundTherapy | External Mic Fix</title>
    <style>
        body { margin: 0; background: #0f172a; color: #f8fafc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #status { font-size: 1rem; color: #38bdf8; text-align: center; margin-bottom: 20px; line-height: 1.6; }
        .start-btn { padding: 20px 50px; font-size: 1.2rem; font-weight: 800; border: none; border-radius: 50px; cursor: pointer; background: #3b82f6; color: white; }
        #mic-label { font-size: 0.8rem; color: #94a3b8; margin-top: 10px; }
        .success { color: #4ade80 !important; font-weight: bold; }
    </style>
</head>
<body>

    <div id="status">System Standby<br>Please connect Wireless Mic first.</div>
    <button class="start-btn" id="startBtn">ACTIVATE SYSTEM</button>
    <div id="mic-label">Active Mic: Waiting...</div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const statusDisp = document.getElementById('status');
        const micLabel = document.getElementById('mic-label');

        const bgMusic = new Audio('music.mp3');
        const maskSound = new Audio('noise.mp3');
        bgMusic.loop = true;
        maskSound.loop = true;

        let audioCtx, analyser, dataArray;

        startBtn.onclick = async function() {
            try {
                // 1. First, request general permission
                const initialStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 2. Look for the Wireless/External Mic
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                // Priority list: Look for 'External', 'Dock', or anything that isn't the Bluetooth headset name
                let targetDeviceId = null;
                let foundLabel = "Internal/Default";

                for (let device of audioDevices) {
                    const label = device.label.toLowerCase();
                    // Usually, wireless receivers show up as "Dock Connector" or "External Microphone"
                    if (label.includes('external') || label.includes('dock') || label.includes('wired')) {
                        targetDeviceId = device.deviceId;
                        foundLabel = device.label;
                        break;
                    }
                }

                // 3. Re-open stream with the SPECIFIC external microphone
                const constraints = {
                    audio: {
                        deviceId: targetDeviceId ? { exact: targetDeviceId } : undefined,
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                };

                const finalStream = await navigator.mediaDevices.getUserMedia(constraints);
                micLabel.innerText = "Active Mic: " + (targetDeviceId ? foundLabel : "Default (Auto-select)");
                micLabel.classList.add('success');

                // 4. Setup Audio Context
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(finalStream);
                analyser = audioCtx.createAnalyser();
                source.connect(analyser);

                bgMusic.volume = 0.4;
                bgMusic.play();
                
                statusDisp.innerHTML = "<span class='success'>CORE ACTIVATED</span><br>Music is playing in High-Fi";
                startBtn.style.display = 'none';

                // Initial stream stop to save resources
                initialStream.getTracks().forEach(track => track.stop());

            } catch (e) {
                alert("Error: " + e.message);
                statusDisp.innerText = "Error occurred. Check permissions.";
            }
        };
    </script>
</body>
</html>
