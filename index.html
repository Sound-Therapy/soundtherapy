import pyaudio
import numpy as np
import time
from ctypes import cast, POINTER
from comtypes import CLSCTX_ALL
from pycaw.pycaw import AudioUtilities, IAudioEndpointVolume

# --- Configuration ---
# Version: v54.2
# Author: Gemini (for Dad's Clinical Project)

THRESHOLD = 0.05        # Noise sensitivity (Adjust this based on drill sound)
BASE_VOLUME = 50        # Default volume (0-100)
MAX_VOLUME = 75         # Target volume when noise detected
NOISE_DURATION = 3      # Must stay noisy for 3 seconds
FADE_UP_TIME = 5        # Transition to MAX_VOLUME (seconds)
FADE_DOWN_TIME = 3      # Transition back to BASE_VOLUME (seconds)

# --- Windows Volume Setup ---
devices = AudioUtilities.GetSpeakers()
interface = devices.Activate(IAudioEndpointVolume._iid_, CLSCTX_ALL, None)
volume_control = cast(interface, POINTER(IAudioEndpointVolume))

def set_master_volume(level):
    # Level: 0 to 100
    volume_control.SetMasterVolumeLevelScalar(level / 100.0, None)

def gradual_volume_change(start, end, duration):
    steps = 20  # Number of steps for smooth transition
    step_sleep = duration / steps
    increment = (end - start) / steps
    
    current = start
    for _ in range(steps):
        current += increment
        set_master_volume(current)
        time.sleep(step_sleep)

# --- Audio Analysis Setup ---
CHUNK = 1024
FORMAT = pyaudio.paInt16
CHANNELS = 1
RATE = 44100

p = pyaudio.PyAudio()
stream = p.open(format=FORMAT, channels=CHANNELS, rate=RATE,
                input=True, frames_per_buffer=CHUNK)

# --- Main Logic ---
print("System Initialized. Starting at Volume 50...")
set_master_volume(BASE_VOLUME)

noise_start_time = None
is_boosted = False

try:
    while True:
        data = np.frombuffer(stream.read(CHUNK), dtype=np.int16)
        rms = np.sqrt(np.mean(data**2)) / 32768.0  # Normalize to 0.0 ~ 1.0

        if rms > THRESHOLD:
            if noise_start_time is None:
                noise_start_time = time.time()
            
            # Check if noise persisted for 3 seconds
            if not is_boosted and (time.time() - noise_start_time >= NOISE_DURATION):
                print(f"Noise detected! Fading up to {MAX_VOLUME} over 5s...")
                gradual_volume_change(BASE_VOLUME, MAX_VOLUME, FADE_UP_TIME)
                is_boosted = True
        else:
            if is_boosted:
                print(f"Noise cleared. Fading down to {BASE_VOLUME} over 3s...")
                gradual_volume_change(MAX_VOLUME, BASE_VOLUME, FADE_DOWN_TIME)
                is_boosted = False
            noise_start_time = None

except KeyboardInterrupt:
    print("Stopping Project...")
finally:
    stream.stop_stream()
    stream.close()
    p.terminate()
