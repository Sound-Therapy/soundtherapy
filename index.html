<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SoundTherapy | Real-time Mixing</title>
    <style>
        body { margin: 0; background: #0f172a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #status { font-size: 1.2rem; margin-bottom: 20px; color: #38bdf8; font-weight: bold; }
        .main-btn { padding: 25px 50px; font-size: 1.5rem; border: none; border-radius: 50px; cursor: pointer; background: #3b82f6; color: white; transition: 0.3s; }
        canvas { width: 90%; height: 150px; background: #1e293b; border-radius: 20px; margin-top: 30px; }
        .mixer-info { margin-top: 20px; font-size: 0.9rem; color: #94a3b8; text-align: center; }
        .alert { color: #ef4444 !important; }
    </style>
</head>
<body>

    <div id="status">READY TO HEAL</div>
    <button class="main-btn" id="startBtn">START THERAPY</button>
    
    <canvas id="visualizer"></canvas>

    <div class="mixer-info">
        Background: <span id="bgStatus">OFF</span> | 
        Masking: <span id="maskStatus">OFF</span>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const statusText = document.getElementById('status');
        const bgStatus = document.getElementById('bgStatus');
        const maskStatus = document.getElementById('maskStatus');
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');

        // Audio Objects
        const bgMusic = new Audio('music.mp3');
        const maskSound = new Audio('noise.mp3');

        // Audio Context & Analyser
        let audioCtx, analyser, dataArray;

        // Loop Settings
        bgMusic.loop = true;
        maskSound.loop = true;

        startBtn.onclick = async () => {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Mic Permission
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioCtx.createMediaStreamSource(stream);
                
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                // Play Background Music (Zero Latency)
                await bgMusic.play();
                bgStatus.innerText = "PLAYING";
                bgStatus.style.color = "#4cd964";

                // Prepare Masking Sound (Start muted)
                await maskSound.play();
                maskSound.volume = 0;
                maskStatus.innerText = "STANDBY";

                startBtn.style.display = 'none';
                statusText.innerText = "MONITORING AMBIENT NOISE";
                renderLoop();

            } catch (err) {
                alert("Please check microphone access and mp3 files.");
                console.error(err);
            }
        };

        function renderLoop() {
            requestAnimationFrame(renderLoop);
            analyser.getByteFrequencyData(dataArray);

            // Analysis: Simple Volume Threshold
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) { sum += dataArray[i]; }
            let average = sum / dataArray.length;

            // Visualizer logic
            canvasCtx.fillStyle = '#1e293b';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
            for(let i = 0; i < dataArray.length; i++) {
                const barHeight = dataArray[i] / 2;
                canvasCtx.fillStyle = `hsl(${200 + barHeight}, 70%, 50%)`;
                canvasCtx.fillRect(i * 3, canvas.height - barHeight, 2, barHeight);
            }

            // Real-time Mixing Logic
            // If noise average is over 40 (adjustable threshold)
            if (average > 40) {
                statusText.innerText = "NOISE DETECTED: ACTIVATING SHIELD";
                statusText.className = "alert";
                maskSound.volume = 1.0; // Instantly play noise.mp3
                maskStatus.innerText = "SHIELDING";
                maskStatus.style.color = "#ef4444";
                document.body.style.background = "#2b0b1a";
            } else {
                statusText.innerText = "MONITORING AMBIENT NOISE";
                statusText.className = "";
                maskSound.volume = 0; // Silent
                maskStatus.innerText = "STANDBY";
                maskStatus.style.color = "#94a3b8";
                document.body.style.background = "#0f172a";
            }
        }
    </script>
</body>
</html>
